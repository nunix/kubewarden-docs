"use strict";(self.webpackChunkkubewarden_docusaurus=self.webpackChunkkubewarden_docusaurus||[]).push([[1392],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||a;return n?o.createElement(h,i(i({ref:t},p),{},{components:n})):o.createElement(h,i({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7199:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var o=n(7462),r=(n(7294),n(3905));const a={sidebar_label:"Context Aware Policies",title:""},i="Context Aware Policies",s={unversionedId:"explanations/context-aware-policies",id:"explanations/context-aware-policies",title:"",description:"Context aware policies allow policy authors to fetch information from the",source:"@site/docs/explanations/context-aware-policies.md",sourceDirName:"explanations",slug:"/explanations/context-aware-policies",permalink:"/explanations/context-aware-policies",draft:!1,editUrl:"https://github.com/kubewarden/docs/edit/main/docs/explanations/context-aware-policies.md",tags:[],version:"current",lastUpdatedAt:1688574838,formattedLastUpdatedAt:"Jul 5, 2023",frontMatter:{sidebar_label:"Context Aware Policies",title:""},sidebar:"docs",previous:{title:"Cluster Operators",permalink:"/testing-policies/cluster-operators"},next:{title:"PSP Migration",permalink:"/tasksDir/psp-migration"}},l={},c=[],p={toc:c},u="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"context-aware-policies"},"Context Aware Policies"),(0,r.kt)("p",null,"Context aware policies allow policy authors to fetch information from the\nKubernetes cluster at evaluation time. This means that context aware policies can determine\nwhether a ",(0,r.kt)("inlineCode",{parentName:"p"},"AdmissionRequest")," has to be accepted or rejected based on other resources already\ndeployed in the cluster.\nFor example, a policy could cross validate information among two different resources type."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Context aware policies are available only in Kubewarden version v1.6.0 or greater.")),(0,r.kt)("p",null,"What a policy can access in the cluster is regulated by the ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/security/service-accounts/"},"Service Account")," of the Policy Server where the policy runs.\nThis allows the cluster administrator to control what a policy can access via traditional Kubernetes RBAC rules. Furthermore, context aware policies have only ",(0,r.kt)("strong",{parentName:"p"},"read")," access to the requested resources."),(0,r.kt)("p",null,"For security reasons, only ",(0,r.kt)("inlineCode",{parentName:"p"},"ClusterAdmissionPolicy")," policies are able fetch information from the Kubernetes cluster. This has been done because ",(0,r.kt)("inlineCode",{parentName:"p"},"AdmissionPolicy")," resources can be deployed by unprivileged users.\nTherefore, if the policy is deployed in a Policy Server with broad access to the resources in the cluster, unprivileged users could get access to prohibited resources.\nTo avoid that, if a context aware policy is deployed as an ",(0,r.kt)("inlineCode",{parentName:"p"},"AdmissionPolicy")," all the attempts to get access to Kubernetes resources will be blocked and reported to the cluster administrator."),(0,r.kt)("p",null,"By default, all the cluster resources are blocked. Thus, at deployment time, the Kubewarden administrator\nmust define which Kubernetes resources each context aware policy is allowed to read.\nThis is done in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ClusterAdmissionPolicy")," definition using the field ",(0,r.kt)("inlineCode",{parentName:"p"},"contextAwareResources")," ."),(0,r.kt)("p",null,"The following example deploys a policy that requires access to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Deployment")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Pod")," resources:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: policies.kubewarden.io/v1\nkind: ClusterAdmissionPolicy\nmetadata:\n  name: context-aware-policy\n  namespace: default\nspec:\n  policyServer: default\n  module: "registry://ghcr.io/kubewarden/policies/context-aware-policy:v1.0.0"\n  settings: {}\n  contextAwareResources:\n    - apiVersion: "apps/v1"\n      kind: "deployment"\n    - apiVersion: "v1"\n      kind: "pod"\n  rules:\n    - apiGroups: ["apps"]\n      apiVersions: ["v1"]\n      resources: ["deployment"]\n      operations:\n        - CREATE\n        - UPDATE\n  mutating: false\n')),(0,r.kt)("p",null,"Policy authors can provide the list of Kubernetes resources accessed by their context aware policy by annotating the policy file. Kubewarden administrators can look into the policy metadata using the ",(0,r.kt)("inlineCode",{parentName:"p"},"kwctl inspect")," command and obtain a list of Kubernetes resources the policy requires access to. This list can then be used to populate the ",(0,r.kt)("inlineCode",{parentName:"p"},"ClusterAdmissionPolicy")," definition."),(0,r.kt)("admonition",{type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"Kubewarden administrators must review carefully the kind of resources the policy is going to access\nto prevent system abuses."),(0,r.kt)("p",{parentName:"admonition"},"For example, a policy evaluating Ingress objects would have very good reasons to read all the ",(0,r.kt)("inlineCode",{parentName:"p"},"Ingress"),"\nresources already defined inside of the cluster. However it would be hard to justify why the same policy\nwould also require access to ",(0,r.kt)("inlineCode",{parentName:"p"},"Secret")," resources."),(0,r.kt)("p",{parentName:"admonition"},"When reviewing the list of resources a context aware policy wants to have access to, approach this process with the same mindset used when evaluating the privileges granted to a smart phone App you're about to install on your mobile device.\nWould you install a torch App that requires access to your address book or your location?"),(0,r.kt)("p",{parentName:"admonition"},"While policies have read-only access to Kubernetes resources, a malicious attacker might abuse a Kubewarden policy to exfiltrate sensitive data from the cluster.")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Resources from the ",(0,r.kt)("inlineCode",{parentName:"p"},"core")," API Group do not need to define the group name, only the version  (e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"v1"),") is required."),(0,r.kt)("p",{parentName:"admonition"},"All the remaining Kubernetes resources require the full definition: ",(0,r.kt)("inlineCode",{parentName:"p"},"groupName/groupVersion"),".")),(0,r.kt)("p",null,"Once deployed, this policy will be able to read the data of the ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"pod")," resources during its evaluations."))}d.isMDXComponent=!0}}]);